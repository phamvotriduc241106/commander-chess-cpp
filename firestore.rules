rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function participantByData(data) {
      return signedIn() &&
        (data.hostUid == request.auth.uid || data.guestUid == request.auth.uid);
    }

    function isGuestJoinUpdate() {
      return signedIn() &&
        resource.data.status == 'waiting' &&
        resource.data.guestUid == null &&
        request.resource.data.hostUid == resource.data.hostUid &&
        request.resource.data.guestUid == request.auth.uid &&
        request.resource.data.status == 'active';
    }

    function immutableMatchFields() {
      return request.resource.data.hostUid == resource.data.hostUid &&
        request.resource.data.createdAt == resource.data.createdAt &&
        (
          resource.data.guestUid == null ||
          request.resource.data.guestUid == resource.data.guestUid
        );
    }

    function isMatchParticipant(matchId) {
      return participantByData(
        get(/databases/$(database)/documents/matches/$(matchId)).data
      );
    }

    match /users/{uid} {
      allow read, create, update: if signedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    match /matches/{matchId} {
      allow read: if true;

      allow create: if signedIn() &&
        request.resource.data.hostUid == request.auth.uid &&
        request.resource.data.status == 'waiting';

      allow update: if signedIn() &&
        immutableMatchFields() &&
        (participantByData(resource.data) || isGuestJoinUpdate());

      allow delete: if false;

      match /signals/{signalId} {
        allow read: if true;
        allow create: if signedIn() &&
          isMatchParticipant(matchId) &&
          request.resource.data.type in ['offer', 'answer', 'ice'] &&
          request.resource.data.from in ['host', 'guest'];
        allow update, delete: if false;
      }

      match /moves/{moveId} {
        allow read: if true;
        allow create: if signedIn() &&
          isMatchParticipant(matchId) &&
          request.resource.data.by in ['host', 'guest'] &&
          request.resource.data.ply is int;
        allow update, delete: if false;
      }
    }
  }
}
